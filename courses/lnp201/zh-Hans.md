---
name: 闪电网络的理论介绍
goal: 从技术角度发现闪电网络
objectives:
  - 理解网络通道的运作方式。
  - 熟悉HTLC、LNURL和UTXO等术语。
  - 吸收管理流动性和LNN费用的知识。
  - 将闪电网络识别为一个网络。
  - 理解闪电网络的理论用途。
---

# 深入比特币的第二层

深入探索闪电网络的核心，这是比特币交易未来的关键系统。LNP201是一个关于闪电网络技术工作原理的理论课程。它揭示了这个第二层网络的基础和机制，旨在使比特币支付快速、经济且可扩展。

通过其支付通道网络，闪电网络能够实现快速和安全的交易，而无需在比特币区块链上记录每一次交换。在各章节中，您将学习如何开启、管理和关闭通道的工作方式，如何通过中间节点安全地路由支付，同时最小化对信任的需求，以及如何管理流动性。您将发现什么是承诺交易、HTLCs、撤销密钥、惩罚机制、洋葱路由和发票。

无论您是比特币初学者还是有更多经验的用户，这门课程都将提供宝贵的信息，以理解和使用闪电网络。虽然我们将在第一部分覆盖一些比特币操作的基础知识，但在深入LNP201之前掌握中本聪发明的基础知识是至关重要的。

享受您的发现之旅！

+++

# 基础知识

<partId>32647d62-102b-509f-a3ba-ad1d6a4345f1</partId>

## 理解闪电网络

<chapterId>df6230ae-ff35-56ea-8651-8e65580730a8</chapterId>

![理解闪电网络](https://youtu.be/PszWk046x-I)

欢迎来到LNP201课程，旨在解释闪电网络的技术功能。

闪电网络是建立在比特币协议之上的支付通道网络，旨在实现快速和低成本的交易。它允许参与者之间创建支付通道，在这些通道内，交易几乎可以即时完成，且费用最小，而无需在区块链上单独记录每笔交易。因此，闪电网络寻求改善比特币的可扩展性，并使其适用于低价值支付。

在探索“网络”方面之前，重要的是要理解闪电上的**支付通道**概念，它是如何工作的，以及其特点。这是本章的主题。

### 支付通道的概念

支付通道允许两方，这里是**Alice**和**Bob**，通过闪电网络交换资金。每个参与者都有一个节点，用圆圈表示，他们之间的通道由一条线段表示。

![LNP201](assets/en/01.webp)

在我们的例子中，Alice在通道的一侧有100,000 satoshis，而Bob有30,000，总共130,000 satoshis，这构成了**通道容量**。

**但什么是satoshi？**

**satoshi**（或“sat”）是比特币上的一个计算单位。类似于欧元的分，satoshi只是比特币的一小部分。一个satoshi等于**0.00000001比特币**，或一亿分之一比特币。随着比特币价值的上升，使用satoshi变得越来越实用。

### 通道中的资金分配

让我们回到支付通道的话题。这里的关键概念是“**通道的一侧**”。每个参与者在通道的一侧都有资金：Alice有100,000 satoshis，Bob有30,000 satoshis。正如我们所见，这些资金的总和代表了通道的总容量，这是在开通时设定的一个数字。

![LNP201](assets/en/02.webp)

我们来看一个闪电网络交易的例子。如果Alice想要发送40,000 satoshis给Bob，这是可能的，因为她有足够的资金（100,000 satoshis）。这笔交易之后，Alice在她那边将剩下60,000 satoshis，而Bob将有70,000 satoshis。

![LNP201](assets/en/03.webp)

**通道容量**保持在130,000 satoshis不变。变化的是资金的分配。这个系统不允许发送超过自己拥有的资金。例如，如果Bob想要回送80,000 satoshis给Alice，他做不到，因为他只有70,000 satoshis。

另一种想象资金分配的方式是想象一个**滑块**，它指示着资金在通道中的位置。最初，Alice有100,000 satoshis，Bob有30,000 satoshis，滑块逻辑上在Alice的一侧。交易了40,000 satoshis之后，滑块会稍微向Bob的一侧移动，现在他有了70,000 satoshis。

![LNP201](assets/en/04.webp)

这种表示方式有助于想象通道中资金的平衡。

### 支付通道的基本规则

首先要记住的一点是，**通道容量**是固定的。这有点像管道的直径：它决定了可以一次性通过通道发送的最大资金量。
我们来举个例子：如果Alice在她那边有130,000 satoshis，她最多只能一次性发送130,000 satoshis给Bob。然而，Bob可以将这些资金部分或全部再发送回Alice。

重要的是要理解，通道的固定容量限制了单笔交易的最大金额，但不限制可能的交易总数，也不限制通道内交换的总资金量。

**你应该从这一章中学到什么？**

- 通道的容量是固定的，决定了单笔交易中可以发送的最大金额。
- 通道中的资金在两个参与者之间分配，每个人只能向对方发送他们在自己一侧拥有的资金。
- 因此，闪电网络允许快速高效地交换资金，同时遵守通道容量所施加的限制。

这是第一章的结尾，我们为闪电网络奠定了基础。在接下来的章节中，我们将看到如何开启一个通道，并更深入地探讨这里讨论的概念。

## 比特币、地址、UTXO和交易

<chapterId>0cfb7e6b-96f0-508b-9210-90bc1e28649d</chapterId>

![比特币、地址、UTXO和交易](https://youtu.be/cadCJ2V7zTg)
本章有些特别，因为它不会直接专注于闪电网络（Lightning Network），而是比特币（Bitcoin）。实际上，闪电网络是建立在比特币之上的一个层。因此，要正确理解后续章节中闪电网络的运作，理解比特币的某些基本概念是至关重要的。在本章中，我们将回顾比特币接收地址、UTXO以及比特币交易的运作基础。

### 比特币地址、私钥和公钥

比特币地址是从**公钥**派生出来的一系列字符，而公钥本身是从**私钥**计算出来的。正如你肯定知道的，它用于锁定比特币，这等同于在我们的钱包中接收它们。

私钥是一个**绝对不应该共享**的秘密元素，而公钥和地址可以在不涉及安全风险的情况下共享（它们的披露只代表对你隐私的风险）。以下是我们将在本培训中采用的常见表示方法：

- **私钥**将以**垂直**方式表示。
- **公钥**将以**水平**方式表示。
- 它们的颜色表示谁拥有它们（爱丽丝为橙色，鲍勃为黑色...）。

### 比特币交易：发送资金和脚本

在比特币上，一笔交易涉及从一个地址发送资金到另一个地址。以爱丽丝向鲍勃发送0.002比特币为例。爱丽丝使用与她的地址关联的私钥**签名**交易，从而证明她确实有能力花费这些资金。但这笔交易背后究竟发生了什么？比特币地址上的资金被一个**脚本**锁定，这是一种小程序，它规定了花费资金的某些条件。

最常见的脚本要求使用与地址关联的私钥进行签名。当爱丽丝用她的私钥签名一笔交易时，她**解锁了**阻止资金的脚本，然后这些资金就可以被转移了。资金的转移涉及给这些资金添加一个新的脚本，规定这次要花费它们，需要**鲍勃的**私钥签名。

![LNP201](assets/en/05.webp)

### UTXO：未花费的交易输出

在比特币上，我们实际交换的不是直接的比特币，而是**UTXO**（_Unspent Transaction Outputs_，未花费的交易输出）。

一个UTXO是一块可以是任何价值的比特币，例如，**2000比特币**、**8比特币**，甚至**8000聪**。每个UTXO都被一个脚本锁定，要花费它，必须满足脚本的条件，通常是一个与给定接收地址对应的私钥的签名。

UTXO不能被分割。每次它们被用来花费它们代表的比特币金额时，必须全部使用。这有点像一张纸币：如果你有一张10欧元的钞票，而你欠面包师5欧元，你不能仅仅把钞票剪成两半。你必须给他10欧元的钞票，然后他会给你5欧元的找零。比特币上的UTXO也是完全相同的原理！例如，当爱丽丝用她的私钥解锁一个脚本时，她解锁了整个UTXO。如果她希望只发送这个UTXO代表的资金的一部分给鲍勃，她可以将其“分割”成几个较小的部分。然后，她将0.0015 BTC发送给鲍勃，并将剩余的0.0005 BTC发送到一个**找零地址**。

以下是一个有2个输出的交易示例：

- 为Bob锁定的0.0015 BTC的UTXO，通过一个脚本锁定，需要Bob的私钥签名。
- 为Alice锁定的0.0005 BTC的UTXO，通过一个脚本锁定，需要她自己的签名。

![LNP201](assets/en/06.webp)

### 多重签名地址

除了从单个公钥生成的简单地址外，还可以从多个公钥创建**多重签名地址**。对于闪电网络来说，一个特别有趣的案例是**2/2多重签名地址**，由两个公钥生成：

![LNP201](assets/en/07.webp)

要花费锁定在这个2/2多重签名地址的资金，需要用与公钥相关联的两个私钥签名。

![LNP201](assets/en/08.webp)

这种类型的地址正是比特币区块链上闪电网络支付通道的具体表现形式。

**你应该从这一章中学到什么？**

- **比特币地址**是从公钥派生的，而公钥本身是从私钥派生的。
- 比特币上的资金通过**脚本**锁定，要花费这些资金，必须满足脚本的要求，通常涉及提供相应私钥的签名。
- **UTXOs**是由脚本锁定的比特币片段，比特币上的每一笔交易都包括解锁一个UTXO，然后反过来创建一个或多个新的UTXO。
- **2/2多重签名地址**需要两个私钥的签名才能花费资金。这些特定的地址在闪电网络的上下文中用于创建支付通道。

这一章关于比特币的内容让我们回顾了一些接下来所需的基本概念。在下一章中，我们将具体探讨在闪电网络上开设通道的工作原理。

# 开设和关闭通道

<partId>900b5b6b-ccd0-5b2f-9424-4b191d0e935d</partId>

## 通道开设

<chapterId>96243eb0-f6b5-5b68-af1f-fffa0cc16bfe</chapterId>

![open a channel](https://youtu.be/B2caBC0Rxko)

在这一章中，我们将更详细地了解如何在闪电网络上开设支付通道，并理解这一操作与底层比特币系统之间的联系。

### 闪电通道

正如我们在第一章中所看到的，闪电网络上的**支付通道**可以比作是两个参与者（在我们的例子中是**Alice**和**Bob**）之间交换资金的“管道”。这个通道的容量对应于每一方可用资金的总和。在我们的例子中，Alice拥有**100,000 satoshis**，Bob拥有**30,000 satoshis**，给出了**总容量**为**130,000 satoshis**。

![LNP201](assets/en/09.webp)

### 信息交换的层次

在闪电网络上清楚地区分不同的交换层次是至关重要的：

- **点对点通信（闪电协议）**：这些是闪电节点互相发送的消息，用于通信。我们将在我们的图表中用虚线黑线表示这些消息。
- **支付通道（闪电协议）**：这些是在闪电上交换资金的路径，我们将用实线黑线表示。
- **比特币交易（比特币协议）**：这些是在链上进行的交易，我们将用橙色线表示。

![LNP201](assets/en/10.webp)
值得注意的是，一个闪电网络节点可以通过P2P协议进行通信，而不需要打开一个通道，但是要交换资金，则必须要有一个通道。

### 打开闪电通道的步骤

1. **消息交换**：Alice想要与Bob打开一个通道。她向他发送一条消息，包含她想要存入通道的金额（130,000 sats）和她的公钥。Bob通过分享他自己的公钥来回应。

![LNP201](assets/en/11.webp)

2. **创建多签名地址**：有了这两个公钥，Alice创建一个**2/2多签名地址**，意味着稍后存入此地址的资金将需要Alice和Bob的两个签名才能被支出。

![LNP201](assets/en/12.webp)

3. **存款交易**：Alice准备一个比特币交易，将资金存入这个多签名地址。例如，她可能决定向这个多签名地址发送**130,000 satoshis**。这个交易是**已构建但尚未在区块链上发布**。

![LNP201](assets/en/13.webp)

4. **提款交易**：在发布存款交易之前，Alice构建一个提款交易，以便在与Bob出现问题时，她可以收回她的资金。实际上，一旦Alice发布了存款交易，她的sats就会被锁定在一个2/2多签名地址上，这需要她和Bob的签名才能解锁。Alice通过构建提款交易来防止这种损失风险，这使她能够随时收回她的资金。

![LNP201](assets/en/14.webp)

5. **Bob的签名**：Alice将存款交易作为证据发送给Bob，并要求他签署提款交易。一旦获得Bob在提款交易上的签名，Alice就确保了她可以随时收回她的资金，因为现在只需要她自己的签名就可以解锁多签名。

![LNP201](assets/en/15.webp)

6. **发布存款交易**：一旦获得Bob的签名，Alice就可以在比特币区块链上发布存款交易，从而正式开启两个用户之间的闪电通道。

![LNP201](assets/en/16.webp)

### 通道何时开启？

一旦存款交易被包含在一个比特币区块中，并且达到了一定的确认深度（后续区块的数量），通道就被视为开启。

**你应该从这一章记住什么？**

- 打开通道开始于双方之间的**消息交换**（交换金额和公钥）。
- 通过创建一个**2/2多签名地址**并通过比特币交易向其存款，形成了一个通道。
- 开通通道的人通过在发布存款交易之前，确保他们可以通过对方签名的提款交易**收回他们的资金**。

在下一章中，我们将探索在通道内进行闪电交易的技术工作原理。

## 承诺交易

<chapterId>7d3fd135-129d-5c5a-b306-d5f2f1e63340</chapterId>

![闪电交易 & 承诺交易](https://youtu.be/aPqI34tpypM)

在本章中，我们将发现在闪电网络上的一个通道内进行交易的技术功能，即当资金从通道的一侧移动到另一侧时。

### 通道生命周期的提醒

如前所述，一个闪电网络通道的开始是通过一笔比特币交易来**开启**的。这个通道可以随时通过一笔比特币交易来**关闭**。在这两个时刻之间，通道内可以执行几乎无限数量的交易，而无需经过比特币区块链。让我们看看通道内的一次交易期间会发生什么。
![LNP201](assets/en/17.webp)

### 通道的初始状态

在开启通道时，Alice在通道的多签名地址上存入了**130,000 satoshis**。因此，在初始状态下，所有资金都在Alice一方。在开启通道之前，Alice还让Bob签署了一份**提款交易**，这将允许她在希望关闭通道时收回她的资金。

![LNP201](assets/en/18.webp)

### 未发布的交易：承诺交易

当Alice在通道内进行交易，向Bob发送资金时，会创建一个新的比特币交易来反映资金分配的变化。这个被称为**承诺交易**的交易没有在区块链上发布，但代表了闪电交易后通道的新状态。

以Alice发送30,000 satoshis给Bob为例：

- **最初**：Alice拥有130,000 satoshis。
- **交易后**：Alice拥有100,000 satoshis，而Bob拥有30,000 satoshis。
  为了验证这次转账，Alice和Bob创建了一个新的**未发布的比特币交易**，该交易将从多签名地址向**Alice发送100,000 satoshis**，向**Bob发送30,000 satoshis**。双方独立构建这笔交易，但使用相同的数据（金额和地址）。构建完成后，每个人都签署交易并与对方交换签名。这允许任何一方在必要时随时发布交易，以便在主比特币区块链上恢复他们在通道中的份额。
  ![LNP201](assets/en/19.webp)

### 转账过程：发票

当Bob想要接收资金时，他会向Alice发送一份**_发票_**，要求30,000 satoshis。然后Alice通过在通道内启动转账来支付这张发票。如我们所见，这个过程依赖于创建和签署一个新的**承诺交易**。

每个承诺交易代表了转账后通道内资金的新分配。在这个例子中，交易后，Bob拥有30,000 satoshis，而Alice拥有100,000 satoshis。如果两个参与者中的任何一个决定在区块链上发布这个承诺交易，它将导致通道的关闭，并且资金将根据这最后的分配进行分配。

![LNP201](assets/en/20.webp)

### 第二次交易后的新状态

让我们再举一个例子：在Alice向Bob发送30,000 satoshis的第一笔交易之后，Bob决定**将10,000 satoshis返还给Alice**。这创建了通道的一个新状态。新的**承诺交易**将代表这个更新的分配：

- **Alice** 现在拥有 **110,000 satoshis**。
- **Bob** 拥有 **20,000 satoshis**。

![LNP201](assets/en/21.webp)

同样，这笔交易没有在区块链上发布，但在通道关闭的情况下可以随时发布。

总结，当资金在一个闪电网络通道内转移时：

- Alice和Bob创建了一个新的**承诺交易**，反映了资金的新分配。- 这笔比特币交易由双方**签名**，但只要通道保持开放，就**不会**在比特币区块链上发布。
- 承诺交易确保每个参与者可以随时通过发布最后签名的交易在比特币区块链上恢复他们的资金。

然而，这个系统有一个潜在的缺陷，我们将在下一章中解决。我们将看到每个参与者如何保护自己不受另一方尝试欺骗的影响。

## 撤销密钥

<chapterId>f2f61e5b-badb-5947-9a81-7aa530b44e59</chapterId>
![transactions part 2](https://youtu.be/RRvoVTLRJ84)
在本章中，我们将深入探讨闪电网络上的交易是如何工作的，讨论为防止欺骗而设置的机制，确保每一方遵守通道内的规则。

### 提醒：承诺交易

如前所述，闪电网络上的交易依赖于未发布的**承诺交易**。这些交易反映了通道中资金的当前分配。当进行新的闪电交易时，会创建并由双方签名一个新的承诺交易，以反映通道的新状态。

让我们来看一个简单的例子：

- **初始状态**：Alice拥有**100,000 satoshis**，Bob拥有**30,000 satoshis**。
- 在一笔交易中，Alice向Bob发送**40,000 satoshis**后，新的承诺交易如下分配资金：
  - Alice: **60,000 satoshis**
  - Bob: **70,000 satoshis**

![LNP201](assets/en/22.webp)

任何时候，双方都可以发布**最新的承诺交易**签名来关闭通道并恢复他们的资金。

### 缺陷：通过发布旧交易进行欺骗

如果一方决定通过发布旧的承诺交易来**欺骗**，就会出现潜在问题。例如，Alice可以发布一个较旧的承诺交易，其中她拥有**100,000 satoshis**，即使现实中她现在只有**60,000**。这将允许她从Bob那里偷走**40,000 satoshis**。

![LNP201](assets/en/23.webp)

更糟糕的是，Alice可以发布最初的提款交易，即开通通道之前的那一笔，其中她拥有**130,000 satoshis**，从而偷走整个通道的资金。

![LNP201](assets/en/24.webp)

### 解决方案：撤销密钥和时间锁

为了防止Alice这种类型的欺骗，在闪电网络上，承诺交易增加了**安全机制**：

1. **时间锁**：每个承诺交易都包括Alice资金的时间锁。时间锁是一种智能合约原语，它设置了一个交易必须满足的时间条件才能被添加到区块中。这意味着，如果Alice发布了其中一个承诺交易，她必须等待一定数量的区块过去后才能恢复她的资金。这个时间锁从承诺交易确认开始适用。其持续时间通常与通道的大小成正比，但也可以手动配置。
2. **撤销密钥**：如果Bob拥有**撤销密钥**，他也可以立即花费Alice的资金。这个密钥由Alice持有的一个秘密和Bob持有的一个秘密组成。注意，每个承诺交易的这个秘密都是不同的。
   感谢这两种结合的机制，Bob有时间检测到Alice试图作弊的企图，并通过使用撤销密钥取回他的输出，对Alice进行惩罚，对Bob来说，这意味着回收频道中的所有资金。我们的新承诺交易现在将如下所示：
   ![LNP201](assets/en/25.webp)

让我们一起详细了解这个机制的运作。

### 交易更新过程

当Alice和Bob通过一个新的闪电交易更新频道状态时，他们会提前交换各自对前一个承诺交易（即将变得过时并可能让其中一方作弊的交易）的**秘密**。这意味着，在频道的新状态中：

- Alice和Bob有一个新的承诺交易，代表了闪电交易后资金的当前分配。
- 每个人都拥有对方上一个交易的秘密，这允许他们在其中一方试图通过在比特币节点的内存池中发布一个旧状态的交易来作弊时使用撤销密钥。确实，为了惩罚另一方，必须持有双方的秘密和对方的承诺交易，其中包括签名的输入。没有这个交易，单独的撤销密钥是无用的。获取这个交易的唯一方法是从内存池（等待确认的交易）中检索它，或者在时间锁定期间从区块链上的已确认交易中检索它，这证明另一方试图作弊，无论是有意还是无意。

让我们通过一个例子来好好理解这个过程：

1. **初始状态**：Alice拥有**100,000 satoshis**，Bob拥有**30,000 satoshis**。

![LNP201](assets/en/26.webp)

2. Bob想通过他们的闪电频道从Alice那里接收40,000 satoshis。为此：
   - 他向她发送了一个发票，连同他对前一个承诺交易撤销密钥的秘密。
   - 作为回应，Alice提供了她对Bob新承诺交易的签名，以及她对前一个交易撤销密钥的秘密。
   - 最后，Bob发送了他对Alice新承诺交易的签名。
   - 这些交换允许Alice通过他们的频道在闪电网络上发送**40,000 satoshis**给Bob，新的承诺交易现在反映了这一新的资金分配。

![LNP201](assets/en/27.webp)

3. 如果Alice试图发布旧的承诺交易，其中她仍然拥有**100,000 satoshis**，Bob获得撤销密钥后，可以立即使用这个密钥回收资金，而Alice则被时间锁定阻塞。

![LNP201](assets/en/28.webp)

即使在这种情况下，Bob没有经济利益去尝试作弊，如果他还是这么做了，Alice也从对称保护中受益，为她提供了相同的保障。

**你应该从这一章中学到什么？**

闪电网络上的**承诺交易**包括安全机制，这些机制减少了作弊的风险和动机。在签署新的承诺交易之前，Alice和Bob交换各自对前一个承诺交易的**秘密**。如果Alice试图发布一个旧的承诺交易，Bob可以使用**撤销密钥**在Alice能够做之前（因为她被时间锁定阻塞）回收所有资金，这惩罚了她试图作弊的行为。

这个安全系统确保参与者遵守闪电网络的规则，他们不能从发布旧的承诺交易中获利。
在这个培训的这个阶段，您现在已经知道了如何开启闪电网络通道以及这些通道内的交易是如何工作的。在下一章中，我们将探索关闭通道并在主区块链上恢复您的比特币的不同方法。

## 通道关闭

<chapterId>29a72223-2249-5400-96f0-3756b1629bc2</chapterId>

![关闭通道](https://youtu.be/FVmQvNpVW8Y)

在本章中，我们将讨论在闪电网络上**关闭通道**的过程，这通过比特币交易完成，就像开启通道一样。在了解了通道内交易的工作方式之后，现在是时候看看如何关闭通道并在比特币区块链上恢复资金了。

### 通道生命周期回顾

**通道的生命周期**始于其**开启**，通过一笔比特币交易，然后在其中进行闪电交易，最终，当各方希望恢复他们的资金时，通过第二笔比特币交易**关闭**通道。在闪电上进行的中间交易由未发布的**承诺交易**表示。

![LNP201](assets/en/29.webp)

### 三种通道关闭方式

有三种主要的关闭通道方式，可以称为**好的、粗暴的和逃避的**（灵感来自Andreas Antonopoulos在*精通闪电网络*中的描述）：

1. **好的**：**合作关闭**，其中Alice和Bob同意关闭通道。
2. **坏的**：**强制关闭**，其中一方决定诚实地关闭通道，但没有另一方的同意。
3. **丑陋的**：**作弊关闭**，其中一方尝试通过发布旧的承诺交易（任何但不是最后一个，反映了资金的实际和公平分配）来窃取资金。

让我们举个例子：

- Alice拥有**100,000 satoshis**，Bob拥有**30,000 satoshis**。
- 这种分配反映在**2个承诺交易**中（每个用户一个），这些交易没有发布，但在通道关闭的情况下可能会发布。

![LNP201](assets/en/30.webp)

### 好的：合作关闭

在**合作关闭**中，Alice和Bob同意关闭通道。以下是过程：

1. Alice通过闪电通信协议向Bob发送消息，提议关闭通道。
2. Bob同意，双方在通道中不再进行任何进一步的交易。

![LNP201](assets/en/31.webp)

3. Alice和Bob一起协商**关闭交易**的费用。这些费用通常基于关闭时比特币费用市场计算。重要的是要注意，**始终是开启通道的人**（在我们的例子中是Alice）支付关闭费用。
4. 他们构建一个新的**关闭交易**。这笔交易类似于承诺交易，但没有时间锁或撤销机制，因为双方都在合作，没有作弊的风险。因此，这种合作关闭交易与承诺交易不同。
   例如，如果Alice拥有**100,000 satoshis**而Bob拥有**30,000 satoshis**，那么结束交易将会向Alice的地址发送**100,000 satoshis**，向Bob的地址发送**30,000 satoshis**，不涉及时间锁限制。一旦这笔交易被双方签名，它就会由Alice发布。一旦交易在比特币区块链上确认，闪电网络通道将正式关闭。
   ![LNP201](assets/en/32.webp)

**合作关闭**是首选的关闭方式，因为它速度快（无时间锁）且交易费用根据当前比特币市场条件进行调整。这避免了支付过少，可能会冒着交易在内存池中被阻塞的风险，或不必要地支付过多，导致参与者不必要的财务损失。

### 坏处：强制关闭

当Alice的节点向Bob发送请求合作关闭的消息，如果他没有回应（例如，由于网络中断或技术问题），Alice可以通过发布**最后签名的承诺交易**进行**强制关闭**。
在这种情况下，Alice将简单地发布最后的承诺交易，该交易反映了最后一次闪电交易发生时通道的状态以及资金的正确分配。

![LNP201](assets/en/33.webp)

这笔交易包括对Alice资金的**时间锁**，使得关闭过程变慢。

![LNP201](assets/en/34.webp)

此外，承诺交易的费用在关闭时可能不合适，因为它们是在创建交易时设置的，有时是几个月前。通常，闪电客户端会高估费用以避免未来的问题，但这可能导致过高的费用，或相反，过低。

总之，**强制关闭**是当对等方不再响应时的最后手段。它比合作关闭更慢、成本更高。因此，应尽可能避免。

### 欺诈：作弊

最后，当其中一方试图发布一个旧的承诺交易时，通常是他们持有的资金超过了应有的数量，这种情况下会发生**作弊**关闭。例如，Alice可能会发布一个旧交易，在那里她拥有**120,000 satoshis**，而她现在实际上只拥有**100,000**。

![LNP201](assets/en/35.webp)

Bob为了防止这种作弊，会监控比特币区块链及其内存池，以确保Alice不会发布旧交易。如果Bob检测到作弊尝试，他可以使用**撤销密钥**来回收Alice的资金，并通过取走通道的全部资金来惩罚她。由于Alice的输出被时间锁阻塞，Bob有时间在他这边没有时间锁的情况下花费它，将全部金额恢复到他拥有的地址上。

![LNP201](assets/en/36.webp)

显然，如果Bob没有在Alice输出的时间锁规定的时间内采取行动，作弊可能会成功。在这种情况下，Alice的输出被解锁，允许她消费它以创建一个新的输出到她控制的地址。

**你应该从这一章中学到什么？**

有三种关闭通道的方式：

1. **合作关闭**：快速且成本较低，双方同意关闭通道并发布一个定制的关闭交易。
2. **强制关闭**：较不理想，因为它依赖于发布一个承诺交易，可能带有不合适的费用和时间锁，这会减慢关闭过程。
3. **作弊**：如果双方之一试图通过发布旧交易来窃取资金，另一方可以使用撤销密钥来惩罚这种作弊行为。
   在接下来的章节中，我们将从更广阔的视角探索闪电网络，重点关注其网络是如何运作的。

# 一个流动性网络

<partId>a873f1cb-751f-5f4a-9ed7-25092bfdef11</partId>

## 闪电网络

<chapterId>45a7252c-fa4f-554b-b8bb-47449532918e</chapterId>

![闪电网络](https://youtu.be/RAZAa3v41DM)

在本章中，我们将探讨即使支付受款人没有通过支付通道直接连接，闪电网络上的支付如何能够到达接收者。事实上，闪电网络是一个**支付通道网络**，它允许通过其他参与者的通道将资金发送到远端节点。我们将发现支付是如何在网络中路由的，流动性如何在通道之间移动，以及交易费用是如何计算的。

### 支付通道网络

在闪电网络上，一笔交易对应于两个节点之间的资金转移。正如前几章所见，进行闪电交易需要与某人开设一个通道。这个通道允许在关闭它以回收链上余额之前进行几乎无限数量的链下交易。然而，这种方法的缺点是需要与另一方直接开设通道才能接收或发送资金，这意味着每个通道都需要一个开启交易和一个关闭交易。如果我计划与这个人进行大量支付，开启和关闭通道变得划算。相反，如果我只需要执行几次闪电交易，直接开启通道就不太有优势，因为这将花费我2次链上交易，而链下交易的数量有限。例如，当想要在商家处使用闪电支付而没有计划返回时，可能会发生这种情况。

为了解决这个问题，闪电网络允许通过多个通道和中间节点路由支付，从而实现无需与另一方直接通道的交易。

例如，想象一下：

- **Alice**（橙色）与**Suzie**（灰色）有一个通道，Alice这边有**100,000 satoshis**，Suzie这边有**30,000 satoshis**。
- **Suzie**与**Bob**有一个通道，其中她拥有**250,000 satoshis**，而Bob没有satoshis。

![LNP201](assets/en/37.webp)

如果Alice想要在不与他直接开通通道的情况下向Bob发送资金，她将不得不通过Suzie，每个通道都需要调整各自一侧的流动性。**发送的satoshis保留在它们各自的通道内**；它们实际上并没有“穿越”通道，但通过调整每个通道内部的流动性来进行转移。

假设Alice想要发送**50,000 satoshis**给Bob：

1. **Alice**在她们共有的通道中向**Suzie**发送50,000 satoshis。
2. **Suzie**通过在她们的通道中向**Bob**发送50,000 satoshis来复制这一转移。

![LNP201](assets/en/38.webp)
因此，通过每个通道中的流动性移动，支付被路由给Bob。操作结束时，Alice最终拥有50,000 sats。她确实转移了50,000 sats，因为最初她有100,000 sats。Bob在他那边，最终多了50,000 sats。对于Suzie（中间节点），这个操作是中性的：最初，她在与Alice的通道中有30,000 sats，在与Bob的通道中有250,000 sats，总共280,000 sats。操作后，她在与Alice的通道中持有80,000 sats，在与Bob的通道中持有200,000 sats，这与开始时的总和相同。
因此，这次转账受到了转账方向上**可用流动性**的限制。

### 路由和流动性限制的计算

让我们以另一个网络的理论例子为例：

- Alice一侧（橙色）在她与**Suzie**（灰色）的通道中有**130,000 satoshis**。
- **Suzie**一侧有**90,000 satoshis**，**Carol**一侧（粉色）有**200,000 satoshis**。
- **Carol**一侧有**150,000 satoshis**，**Bob**一侧有**100,000 satoshis**。

![LNP201](assets/en/39.webp)

在这种配置下，Alice能发送给Bob的最大金额是**90,000 satoshis**，因为她受到了从**Suzie到Carol**通道中可用的最小流动性的限制。反方向（从Bob到Alice），不可能进行支付，因为**Suzie**在与**Alice**的通道中没有satoshis。因此，这个方向上没有**可用路由**进行转账。
Alice通过通道发送**40,000 satoshis**给Bob：

1. Alice将40,000 satoshis转移到她与Suzie的通道。
2. Suzie将40,000 satoshis转移到她们共享的通道中的Carol。
3. Carol最终将40,000 satoshis转移到Bob。

![LNP201](assets/en/40.webp)

每个通道中**发送的satoshis** **保留在通道中**，所以Carol发送给Bob的satoshis与Alice发送给Suzie的不同。转账仅通过调整每个通道内的流动性来完成。此外，通道的总容量保持不变。

![LNP201](assets/en/41.webp)

如前一个例子所示，交易后，源节点（Alice）少了40,000 satoshis。中间节点（Suzie和Carol）保持相同的总金额，使得操作对他们来说是中性的。最终，目的节点（Bob）收到额外的40,000 satoshis。

中间节点在闪电网络的运作中因此扮演着非常重要的角色。他们通过提供支付的多条路径来促进转账。为了鼓励这些节点提供他们的流动性并参与路由支付，**路由费**被支付给他们。

### 路由费

中间节点对通过他们的通道进行的支付征收费用。这些费用由**每个节点为每个通道**设置。费用由2个部分组成：

1. "**基础费**"：每个通道的固定金额，通常默认为**1 sat**，但可以自定义。
2. "**可变费用**"：转账金额的一定百分比，以**百万分之一（ppm）**计算。默认情况下，它是**1 ppm**（每转移一百万satoshis支付1 sat），但也可以调整。
   费用还取决于转账的方向。例如，从Alice转账给Suzie，适用Alice的费用。相反，从Suzie转给Alice，使用Suzie的费用。

例如，对于Alice和Suzie之间的通道，我们可能有：

- **Alice**：基础费用为1 sat，可变费用为1 ppm。
- **Suzie**：基础费用为0.5 sat，可变费用为10 ppm。

![LNP201](assets/en/42.webp)

为了更好地理解费用是如何工作的，让我们研究之前相同的闪电网络，但现在有以下路由费用：

- **Alice - Suzie**通道：Alice的基础费用为1 satoshi，可变费用为1 ppm。
- **Suzie - Carol**通道：Suzie的基础费用为0 satoshi，可变费用为200 ppm。
- **Carol - Bob**通道：Suzie 2的基础费用为1 satoshi，可变费用为1 ppm。
  ![LNP201](assets/en/43.webp)

对于向Bob支付的**40,000 satoshis**，Alice将不得不发送更多一点，因为每个中间节点都会扣除其费用：

- **Carol**在与Bob的通道上扣除1.04 satoshis：
  $$ f*{\text{Carol-Bob}} = \text{基础费用} + \left(\frac{\text{ppm} \times \text{金额}}{10^6}\right) $$
  $$ f*{\text{Carol-Bob}} = 1 + \frac{1 \times 40000}{10^6} = 1 + 0.04 = 1.04 \text{ sats} $$

- **Suzie**在与Carol的通道上扣除8 satoshis的费用：
  $$ f*{\text{Suzie-Carol}} = \text{基础费用} + \left(\frac{\text{ppm} \times \text{金额}}{10^6}\right) $$
  $$ f*{\text{Suzie-Carol}} = 0 + \frac{200 \times 40001.04}{10^6} = 0 + 8.0002 \approx 8 \text{ sats} $$

因此，这条路径上此次支付的总费用是**9.04 satoshis**。因此，Alice必须发送**40,009.04 satoshis**，以便Bob准确收到**40,000 satoshis**。

![LNP201](assets/en/44.webp)

因此，流动性得到了更新：

![LNP201](assets/en/45.webp)

### 洋葱路由

为了将支付从发送者路由到接收者，闪电网络使用一种称为“**洋葱路由**”的方法。与基于目的地决定数据方向的传统数据路由不同，洋葱路由的工作方式有所不同：

- **发送节点计算整个路由**：例如，Alice确定她的支付必须经过Suzie和Carol，然后才能到达Bob。
- **每个中间节点只知道其直接邻居**：Suzie只知道她从Alice收到了资金，并且她必须将它们转给Carol。然而，Suzie不知道Alice是源节点还是中间节点，她也不知道Carol是接收节点还是另一个中间节点。这一原则也适用于Carol和路径上的所有其他节点。因此，洋葱路由通过掩盖发送者和最终接收者的身份来保持交易的机密性。为了确保传输节点可以在洋葱路由中计算出一条完整的到达接收者的路线，它必须维护一个**网络图**来了解其拓扑结构并确定可能的路线。
  **你应该从这一章中学到什么？**

1. 在Lightning上，支付可以通过间接连接的中间通道在节点之间路由。这些中间节点促进了流动性中继。
2. 中间节点为他们的服务收取佣金，包括固定费用和可变费用。
3. 洋葱路由允许传输节点计算完整路线，而无需中间节点知道源或最终目的地。

在本章中，我们探讨了Lightning Network上的支付路由。但是，一个问题出现了：什么阻止中间节点接受传入的支付而不将其转发到下一个目的地，以此来截取交易？这正是我们将在下一章中研究的HTLCs的作用。

## HTLC – 哈希时间锁定合约

<chapterId>4369b85a-1365-55d8-99e1-509088210116</chapterId>

![HTLC](https://youtu.be/-JC4mkq7H48)

在本章中，我们将发现Lightning是如何允许支付通过中间节点进行传输，而无需信任它们，这要归功于**HTLC**（_哈希时间锁定合约_）。这些智能合约确保每个中间节点只有在将支付转发给最终接收者后才能从其通道中获得资金，否则，支付将不会被验证。

因此，支付路由面临的问题是对中间节点的必要信任，以及中间节点之间的相互信任。为了说明这一点，让我们重新访问我们的简化Lightning网络示例，其中包含3个节点和2个通道：

- Alice与Suzie有一个通道。
- Suzie与Bob有一个通道。

Alice想要发送40,000 sats给Bob，但她与他没有直接通道，也不希望开设一个。她寻找一条路线，并决定通过Suzie的节点。

![LNP201](assets/en/46.webp)

如果Alice天真地发送40,000 satoshis给Suzie，希望Suzie会将这笔钱转给Bob，Suzie可能会将资金留给自己，不传递给Bob。

![LNP201](assets/en/47.webp)
为了避免这种情况，在Lightning上，我们使用HTLCs（哈希时间锁定合约），这使得对中间节点的支付是有条件的，意味着Suzie必须满足某些条件才能访问Alice的资金并将其转给Bob。

### HTLCs的工作原理

HTLC是一种基于两个原则的特殊合约：

- **访问条件**：接收者必须揭示一个秘密来解锁属于他们的支付。
- **到期**：如果支付在定义的期限内没有完全完成，它将被取消，资金将返回给发送者。

以下是我们的示例中Alice、Suzie和Bob的这一过程如何运作的：

![LNP201](assets/en/48.webp)
**创建秘密**：Bob生成一个随机的秘密，记为*s*（原像），并使用哈希函数（记为*h*）计算其哈希值，记为*r*。我们有：

$$
r = h(s)
$$

使用哈希函数使得仅凭*h(s)*无法找到*s*，但如果提供了*s*，很容易验证它对应于*h(s)*。

![LNP201](assets/en/49.webp)

**发送支付请求**：Bob向Alice发送一个**发票**，请求支付。这个发票特别包括哈希*r*。

![LNP201](assets/en/50.webp)

**发送条件付款**：Alice向Suzie发送一个40,000 satoshis的HTLC。Suzie获得这些资金的条件是她提供一个满足以下方程的秘密*s'*：

$$
h(s') = r
$$

![LNP201](assets/en/51.webp)

**将HTLC转移到最终接收者**：Suzie，为了从Alice那里获得40,000 satoshis，必须将一个相似的40,000 satoshis的HTLC转移到Bob那里，他有相同的条件，即他必须提供一个满足方程的秘密*s'*给Suzie：

$$
h(s') = r
$$

![LNP201](assets/en/52.webp)

**通过秘密*s*验证**：Bob提供*s*给Suzie以接收HTLC中承诺的40,000 satoshis。有了这个秘密，Suzie就可以解锁Alice的HTLC并从Alice那里获得40,000 satoshis。然后支付正确地路由到Bob。

![LNP201](assets/en/53.webp)

这个过程防止了Suzie在没有完成对Bob的转账的情况下保留Alice的资金，因为她必须将支付发送给Bob以获得秘密*s*，从而解锁Alice的HTLC。即使路由包括几个中间节点，操作仍然相同：只是简单地重复Suzie对每个中间节点的步骤。每个节点都受到HTLCs条件的保护，因为解锁最后一个HTLC的接收者会自动触发所有其他HTLCs的级联解锁。

### HTLCs在出现问题时的过期和管理

如果在支付过程中，其中一个中间节点或接收节点停止响应，特别是在互联网或电力中断的情况下，那么支付无法完成，因为解锁HTLCs所需的秘密没有传输。以Alice、Suzie和Bob为例，如果Bob没有将秘密*s*传给Suzie，就会发生这个问题。在这种情况下，路径上游的所有HTLCs都被阻塞，它们保护的资金也是如此。

![LNP201](assets/en/54.webp)

为了避免这种情况，Lightning上的HTLCs有一个过期时间，如果在一定时间后没有完成，就允许移除HTLC。过期遵循特定的顺序，因为它首先从最接近接收者的HTLC开始，然后逐步上移至交易的发起者。在我们的例子中，如果Bob从未给Suzie秘密*s*，这将首先导致Suzie向Bob的HTLC过期。

![LNP201](assets/en/55.webp)

然后是从Alice到Suzie的HTLC。

![LNP201](assets/en/56.webp)

如果到期顺序被颠倒，Alice可以在Suzie保护自己免受潜在欺诈之前收回她的付款。实际上，如果Bob回来要求他的HTLC，而Alice已经移除了她的HTLC，Suzie将处于不利地位。因此，HTLC到期的这种级联顺序确保了没有中介节点遭受不公平的损失。

### HTLC在承诺交易中的表示

承诺交易以这样一种方式表示HTLC，即它们对Lightning的条件可以在HTLC生命周期内强制关闭通道时转移到比特币上。作为提醒，承诺交易代表两个用户之间通道的当前状态，并允许在出现问题时单方面强制关闭。每次通道状态更新时，会创建2个承诺交易：每方一个。让我们重新审视Alice、Suzie和Bob的例子，但更仔细地看看在创建HTLC时Alice和Suzie之间的通道级别发生了什么。
![LNP201](assets/en/57.webp)

在Alice和Bob之间开始40,000 sats支付之前，Alice在她与Suzie的通道中有100,000 sats，而Suzie持有30,000。他们的承诺交易如下：

![LNP201](assets/en/58.webp)

Alice刚刚收到Bob的发票，其中显著包含*r*，即秘密的哈希值。因此，她可以与Suzie构建一个40,000 satoshis的HTLC。这个HTLC在最新的承诺交易中被表示为Alice一侧的输出，称为“**_HTLC Out_**”，因为资金是外出的，而在Suzie一侧称为“**_HTLC In_**”，因为资金是流入的。

![LNP201](assets/en/59.webp)

与HTLC相关的这些输出共享完全相同的条件，即：

- 如果Suzie能够提供秘密*s*，她可以立即解锁此输出并将其转移到她控制的地址。
- 如果Suzie不拥有秘密*s*，她无法解锁此输出，Alice将能够在时间锁之后解锁它，将其发送到她控制的地址。时间锁因此给予Suzie一个反应的期限，以防她获得*s*。

这些条件仅在通道关闭（即，承诺交易在链上发布）而HTLC在Lightning上仍然活跃时适用，意味着Alice和Bob之间的支付尚未最终完成，且HTLC尚未到期。得益于这些条件，Suzie可以通过提供*s*来回收她应得的40,000 satoshis的HTLC。否则，Alice在时间锁到期后回收资金，因为如果Suzie不知道*s*，这意味着她没有将40,000 satoshis转给Bob，因此，Alice的资金不欠她。

此外，如果在多个HTLC待处理时关闭通道，将会有与进行中的HTLC一样多的额外输出。
如果通道未关闭，则在Lightning支付到期或成功后，将创建新的承诺交易以反映通道的新的、现在稳定的状态，即没有任何待处理的HTLC。因此，与HTLC相关的输出可以从承诺交易中移除。
![LNP201](assets/en/60.webp)

最终，在HTLC处于活动状态时进行合作通道关闭的情况下，Alice和Suzie停止接受新的支付，并等待正在进行的HTLCs的解决或到期。这使他们能够发布一个更轻的关闭交易，不包含与HTLCs相关的输出，从而减少费用并避免等待可能的时间锁。

**你应该从这一章中学到什么？**

HTLCs使得通过多个节点路由闪电网络支付成为可能，而无需信任这些节点。以下是需要记住的关键点：

1. HTLCs通过一个秘密（预像）和一个到期时间来确保支付的安全性。
2. HTLCs的解决或到期遵循特定顺序：然后从目的地向源头进行，以保护每个节点。
3. 只要HTLC既未解决也未到期，它就作为最新承诺交易中的一个输出被保持。

在下一章中，我们将发现节点发起一个闪电网络交易时，如何找到并选择路由以使其支付到达接收节点。

## 寻找你的路

<chapterId>7e2ae959-c2a1-512e-b5d6-8fd962e819da</chapterId>

![寻找你的路](https://youtu.be/wnUGJjOxd9Q)

在前几章中，我们看到了如何使用其他节点的通道来路由支付，并达到一个不需要通过通道直接连接的节点。我们还讨论了如何确保在不信任中介节点的情况下转移的安全性。在本章中，我们将专注于找到到达目标节点的最佳可能路由。

### 闪电网络中的路由问题

正如我们所见，在闪电网络中，必须由支付发送节点计算到接收者的完整路由，因为我们使用了一个洋葱路由系统。中介节点既不知道起点也不知道最终目的地。他们只知道支付从哪里来以及下一步应该转移到哪个节点。这意味着发送节点必须维护网络的动态本地拓扑，包括现有的闪电网络节点和每个节点之间的通道，同时考虑开通、关闭和状态更新。

![LNP201](assets/en/61.webp)
即使有了这种闪电网络的拓扑结构，对于路由来说仍有一些关键信息对发送节点来说是无法获取的，那就是任何给定时刻通道中的确切资金分配情况。实际上，每个通道只显示其**总容量**，但资金的内部分配只有两个参与节点知道。这对于高效路由构成了挑战，因为支付的成功特别取决于其金额是否小于所选路由上的最低流动性。然而，流动性对发送节点并不都是可见的。
![LNP201](assets/en/62.webp)

### 网络地图更新

为了保持他们的网络地图最新，节点通过一种称为“**_gossip_**”的算法定期交换消息。这是一种分布式算法，用于以流行病方式将信息传播到网络中的所有节点，从而允许在几个通信周期内交换和同步通道的全球状态。每个节点将信息传播给一个或多个随机或非随机选择的邻居，这些邻居又将信息传播给其他邻居，依此类推，直到达到全球同步状态。

闪电网络节点之间交换的2种主要消息如下：

- “**通道公告**”：标志着新通道开通的消息。
- **频道更新**：更新频道状态的消息，特别是关于费用的演变（但不包括流动性的分配）。
  闪电网络节点还监控比特币区块链以检测频道关闭交易。关闭的频道随后会从地图中移除，因为它不再能用于路由我们的支付。

### 路由支付

让我们以一个小型的闪电网络为例，该网络有7个节点：Alice, Bob, 1, 2, 3, 4, 和 5。假设Alice想要向Bob发送支付，但必须经过中间节点。

![LNP201](assets/en/63.webp)

以下是这些频道中资金的实际分布：

- **Alice和1之间的频道**：Alice一侧250,000 sats，1一侧80,000 sats（总容量330,000 sats）。
- **1和2之间的频道**：1一侧300,000 sats，2一侧200,000 sats（总容量500,000 sats）。
- **2和3之间的频道**：2一侧50,000 sats，3一侧60,000 sats（总容量110,000 sats）。
- **2和5之间的频道**：2一侧90,000 sats，5一侧160,000 sats（总容量250,000 sats）。
- **2和4之间的频道**：2一侧180,000 sats，4一侧110,000 sats（总容量290,000 sats）。
- **4和5之间的频道**：4一侧200,000 sats，5一侧10,000 sats（总容量210,000 sats）。
- **3和Bob之间的频道**：3一侧50,000 sats，Bob一侧250,000 sats（总容量300,000 sats）。
- **5和Bob之间的频道**：5一侧260,000 sats，Bob一侧100,000 sats（总容量360,000 sats）。

![LNP201](assets/en/64.webp)

为了从Alice向Bob支付100,000 sats，路由选项受到每个频道中可用流动性的限制。基于已知的流动性分布，Alice的最佳路由可能是序列 `Alice → 1 → 2 → 4 → 5 → Bob`：

![LNP201](assets/en/65.webp)

但由于Alice不知道每个频道中资金的确切分布，她必须根据以下标准概率性地估计最佳路由：

- **成功的概率**：总容量更高的频道更有可能包含足够的流动性。例如，节点2和节点3之间的频道总容量为110,000 sats，所以在节点2一侧找到100,000 sats或更多是不太可能的，尽管这仍然是可能的。
- **交易费用**：在选择最佳路由时，发送节点还考虑每个中间节点应用的费用，并寻求最小化总路由成本。
- **HTLCs的过期时间**：为了避免支付被阻塞，HTLCs的过期时间也是一个需要考虑的参数。
- **中间节点数量**：最后，更广泛地说，发送节点会寻找具有尽可能少的节点的路由，以减少失败的风险并限制闪电网络交易费用。
  通过分析这些标准，发送节点可以测试最可能的路由并尝试优化它们。在我们的例子中，Alice可以如下对最佳路由进行排名：

1. `Alice → 1 → 2 → 5 → Bob`，因为这是最短且容量最大的路由。
2. `Alice → 1 → 2 → 4 → 5 → Bob`，因为这条路由虽然比第一条长，但提供了良好的容量。
3. `Alice → 1 → 2 → 3 → Bob`，因为这条路由包括了`2 → 3`通道，其容量非常有限，但仍然可能可用。

### 支付执行

Alice决定测试她的第一条路由（`Alice → 1 → 2 → 5 → Bob`）。因此，她向节点1发送了100,000 sats的HTLC。该节点检查它与节点2的流动性是否充足，并继续传输。节点2随后从节点1接收到HTLC，但意识到它在与节点5的通道中没有足够的流动性来路由100,000 sats的支付。然后，它向节点1发送错误消息，节点1将消息传递给Alice。这条路由失败了。

![LNP201](assets/en/66.webp)

Alice然后尝试使用她的第二条路由（`Alice → 1 → 2 → 4 → 5 → Bob`）来路由她的支付。她向节点1发送了100,000 sats的HTLC，节点1将其传递给节点2，然后是节点4，节点5，最后到Bob。这一次，流动性充足，路由功能正常。每个节点使用Bob提供的预映像（秘密*s*）依次解锁其HTLC，这允许Alice的支付成功地完成给Bob。

![LNP201](assets/en/67.webp)

寻找路由的过程如下：发送节点首先识别最可能的路由，然后依次尝试支付，直到找到一个功能性的路由。

值得注意的是，Bob可以在**发票**中提供信息以便于路由。例如，他可以指出附近有足够流动性的通道或揭示私有通道的存在。这些指示允许Alice避免成功机会小的路由，并首先尝试Bob推荐的路径。

**你应该从这一章中学到什么？**

1. 节点通过公告和监控比特币区块链上的通道关闭来维护网络拓扑图。
2. 寻找支付的最佳路由仍然是概率性的，取决于许多标准。
3. Bob可以在**发票**中提供指示，以指导Alice的路由并避免她测试不太可能的路由。

在接下来的章节中，我们将具体研究发票的功能，以及闪电网络上使用的一些其他工具。

# 闪电网络的工具

<partId>74d6c334-ec5d-55d9-8598-f05694703bf6</partId>

## 发票，LNURL，和Keysend

<chapterId>e34c7ecd-2327-52e3-b61e-c837d9e5e8b0</chapterId>
![发票，LNURL，Keysend](https://youtu.be/CHnXJuZTarU)
在本章中，我们将更仔细地研究闪电网络**发票**的操作，即接收节点发送给发送节点的支付请求。目标是理解如何在闪电网络上支付和接收支付。我们还将讨论两种替代传统发票的方法：LNURL和Keysend。
![LNP201](assets/en/68.webp)

### 闪电发票的结构

如HTLCs章节所解释的，每笔支付都始于接收方生成一个**发票**。然后，这个发票通过二维码或复制粘贴的方式传输给付款人，以启动支付。一个发票主要包含两部分：

1. **人类可读部分**：此部分包含清晰可见的元数据，以增强用户体验。
2. **有效载荷**：此部分包含供机器处理支付的信息。

一个典型的发票结构以标识符`ln`开头，代表“闪电”，接着是`bc`代表比特币，然后是发票的金额。分隔符`1`用来区分人类可读部分和数据（有效载荷）部分。

让我们以以下发票为例：

```invoice
lnbc100u1p0x7x7dpp5l7r9y50wrzz0lwnsqgxdks50lxtwkl0mhd9lslr4rcgdtt2n6lssp5l3pkhdx0cmc9gfsqvw5xjhph84my2frzjqxqyz5vq9qsp5k4mkzv5jd8u5n89d2yc50x7ptkl0zprx0dfjh3km7g0x98g70hsqq7sqqqgqqyqqqqlgqqvnv2k5ehwnylq3rhpd9g2y0sq9ujyxsqqypjqqyqqqqqqqqqqqsqqqqq9qsq3vql5f6e45xztgj7y6xw6ghrcz3vmh8msrz8myvhsarxg42ce9yyn53lgnryx0m6qqld8fql
```

我们已经可以将其分为两部分。首先是人类可读部分：

```invoice
lnbc100u
```

然后是用于有效载荷的部分：

```invoice

p0x7x7dpp5l7r9y50wrzz0lwnsqgxdks50lxtwkl0mhd9lslr4rcgdtt2n6lssp5l3pkhdx0cmc9gfsqvw5xjhph84my2frzjqxqyz5vq9qsp5k4mkzv5jd8u5n89d2yc50x7ptkl0zprx0dfjh3km7g0x98g70hsqq7sqqqgqqyqqqqlgqqvnv2k5ehwnylq3rhpd9g2y0sq9ujyxsqqypjqqyqqqqqqqqqqqsqqqqq9qsq3vql5f6e45xztgj7y6xw6ghrcz3vmh8msrz8myvhsarxg42ce9yyn53lgnryx0m6qqld8fql
```

两部分由`1`分隔。选择这个分隔符而不是特殊字符，是为了允许通过双击轻松复制整个发票。

在第一部分中，我们可以看到：

- `ln`表示这是一个闪电网络交易。
- `bc`表示闪电网络运行在比特币区块链上（而不是在测试网或Litecoin上）。
- `100u`表示发票金额，以**微聪**（`u`代表"微"）表示，这里等于10,000聪。

为了指定支付金额，它以比特币的子单位表示。这里使用的单位有：

- **毫比特币（表示为`m`）：** 代表一比特币的千分之一。

  $$
  1 \, \text{mBTC} = 10^{-3} \, \text{BTC} = 10^5 \, \text{聪}
  $$

- **微比特币（表示为`u`）：** 有时也称为"bit"，代表一比特币的百万分之一。

  $$
  1 \, \mu\text{BTC} = 10^{-6} \, \text{BTC} = 100 \, \text{聪}
  $$

- **纳比特币（表示为`n`）：** 代表一比特币的十亿分之一。

  $$
  1 \, \text{nBTC} = 10^{-9} \, \text{BTC} = 0.1 \, \text{聪}
  $$

- **皮比特币（表示为`p`）：** 代表一比特币的万亿分之一。
  $$
  1 \, \text{pBTC} = 10^{-12} \, \text{BTC} = 0.0001 \, \text{聪}
  $$

### 发票的有效载荷

发票的有效载荷包括处理支付所需的几个信息：

- **时间戳：** 发票创建的时刻，以Unix时间戳表示（自1970年1月1日以来已经过的秒数）。
- **哈希秘密：** 正如我们在HTLCs部分看到的，接收节点必须向发送节点提供预映像的哈希。这在HTLCs中用于保护交易。我们将其称为“_r_”。
- **支付秘密：** 另一个由接收方生成的秘密，但这次是传输给发送节点的。它在洋葱路由中使用，以防止中间节点猜测下一个节点是否为最终接收者。这样就对于路由上的最后一个中间节点，保持了接收者的一种保密性。
- **接收者的公钥：** 向付款人指示要支付的人的标识符。
- **过期时长：** 发票支付的最长时间（默认为1小时）。
- **路由提示：** 接收者提供的额外信息，帮助发送者优化支付路由。
- **签名：** 通过验证所有信息来保证发票的完整性。

然后，发票以**bech32**编码，与比特币SegWit地址（以`bc1`开头的格式）相同。

### LNURL提现

在传统交易中，比如商店购买，会为要支付的总金额生成发票。一旦发票以二维码或字符串的形式出现，顾客就可以扫描它并完成交易。然后支付遵循我们在前一节中学习的传统流程。然而，这个过程有时对用户体验来说可能非常繁琐，因为它要求接收者通过发票向发送者发送信息。
对于某些情况，如从在线服务提取比特币，传统过程过于繁琐。在这种情况下，**LNURL**提款解决方案通过显示二维码简化了这个过程，接收者的钱包扫描后自动创建发票。然后服务支付发票，用户只需看到即时提款。

![LNP201](assets/en/69.webp)

LNURL是一个通信协议，指定了一组旨在简化闪电网络节点与客户端以及第三方应用之间互动的功能。正如我们刚刚看到的，LNURL提款只是其他功能中的一个例子。
该协议基于HTTP，允许创建各种操作的链接，如支付请求、提款请求或其他增强用户体验的功能。每个LNURL都是一个带有lnurl前缀的bech32编码URL，一旦扫描，就会触发闪电钱包上的一系列自动动作。
例如，LNURL-withdraw（LUD-03）功能允许通过扫描二维码从服务中提取资金，无需手动生成发票。同样，LNURL-auth（LUD-04）允许使用闪电钱包上的私钥而不是密码登录在线服务。

### 无需发票发送闪电支付：Keysend

另一个有趣的案例是在事先没有收到发票的情况下转移资金，称为“**Keysend**”。该协议允许通过在加密支付数据中添加预映像来发送资金，只有接收者才能访问这个预映像。这个预映像使接收者能够解锁HTLC，从而在事先没有生成发票的情况下检索资金。

简而言之，在这个协议中，是发送者生成用于HTLCs的秘密，而不是接收者。实际上，这允许发送者在事先没有与接收者互动的情况下进行支付。

![LNP201](assets/en/70.webp)

**你应该从这一章中学到什么？**

1. **闪电发票**是一个支付请求，由人类可读部分和机器数据部分组成。
2. 发票采用**bech32**编码，使用`1`分隔符以便复制，数据部分包含处理支付所需的所有信息。
3. 闪电上存在其他支付过程，特别是**LNURL-Withdraw**以便于提款，以及**Keysend**用于无需发票的直接转账。

在接下来的章节中，我们将看到节点操作员如何管理他们的通道流动性，以确保永远不会被阻塞，总能在闪电网络上发送和接收支付。

## 管理您的流动性

<chapterId>cc76d0c4-d958-57f5-84bf-177e21393f48</chapterId>

![管理您的流动性](https://youtu.be/YuPrbhEJXbg)

在本章中，我们将探索在闪电网络上有效管理流动性的策略。流动性管理根据用户类型和上下文而有所不同。我们将查看主要原则和现有技术，以更好地理解如何优化这一管理。

### 流动性需求

在Lightning上有三种主要的用户配置文件，每个都有特定的流动性需求：

1. **付款人（The Payer）**：这是进行支付的人。他们需要外向流动性才能将资金转移给其他用户。例如，这可以是一个消费者。
2. **卖家（或收款人，The Seller or Payee）**：这是接收支付的人。他们需要进入流动性才能接受对他们节点的支付。例如，这可以是一个商家或在线商店。
3. **路由器（The Router）**：一个中介节点，通常专门用于路由支付，必须优化其每个通道中的流动性，以路由尽可能多的支付并赚取费用。

这些配置文件显然不是固定的；用户可以根据交易在付款人和收款人之间切换。例如，Bob可以通过Lightning从他的雇主那里收到他的工资，将他置于需要进入流动性的“卖家”位置。随后，如果他想用他的工资买食物，他变成了一个“付款人”，必须拥有外向流动性。

为了更好地理解，让我们以一个由三个节点组成的简单网络为例：买家（Alice）、路由器（Suzie）和卖家（Bob）。

![LNP201](assets/en/71.webp)

想象买家想要发送30,000 sats给卖家，而支付通过路由器的节点进行。每方必须在支付方向上拥有最低限度的流动性：

- 付款人必须在与路由器的通道的他们这一侧至少有30,000 satoshis。
- 卖家必须有一个通道，在对面有30,000 satoshis才能接收它们。
- 路由器必须在他们与付款人的通道中的付款人这一侧有30,000 satoshis，并且在他们与卖家的通道中的他们这一侧也有30,000 satoshis，才能路由支付。

![LNP201](assets/en/72.webp)

### 流动性管理策略

付款人必须确保在他们通道的这一侧保持足够的流动性，以保证外向流动性。这证明相对简单，因为只需打开新的Lightning通道就可以拥有这种流动性。实际上，多签名链上锁定的初始资金在Lightning通道开始时完全在付款人这一侧。只要以足够的资金打开通道，支付能力就得到了保证。当外向流动性耗尽时，只需打开新的通道即可。
另一方面，对于卖家来说，任务更加复杂。为了能够接收支付，他们必须在他们的通道的对面拥有流动性。因此，仅仅打开一个通道是不够的：他们还必须在这个通道中进行支付，以将流动性移动到另一侧，然后他们才能自己接收支付。对于某些Lightning用户配置文件，如商家，由于其节点发送和接收的不成比例，存在明显的不平衡，因为商业的主要目标是收集比它花费的更多，以产生利润。幸运的是，对于这些有特定进入流动性需求的用户，存在几种解决方案：

- **吸引通道**：商家由于预期在其节点上接收的大量进入支付而获得优势。考虑到这一点，他们可以尝试吸引寻求通过交易费用获得收入的路由节点，并希望向他们开放通道，以期路由他们的支付并收集相关费用。
- **流动性移动**：卖方也可以开设一个通道，并通过向另一个节点进行虚构支付的方式，将部分资金转移到对面。我们将在下一部分看到如何执行此操作。
- **三角开通**：存在用于希望协作开通通道的节点的平台，允许每个节点从立即获得的进出流动性中受益。例如，[LightningNetwork+](https://lightningnetwork.plus/) 提供此服务。如果 Alice、Bob 和 Suzie 想要开通一个拥有 100,000 sats 的通道，他们可以在这个平台上达成协议，由 Alice 向 Bob 开通通道，Bob 向 Suzie 开通，Suzie 则向 Alice 开通。这样，每个人都拥有 100,000 sats 的出站流动性和 100,000 sats 的入站流动性，同时只锁定了 100,000 sats。

![LNP201](assets/en/73.webp)

- **购买通道**：也存在用于租赁 Lightning 通道以获得入站流动性的服务，如 [Bitrefill Thor](https://www.bitrefill.com/thor-lightning-network-channels/) 或 [Lightning Labs Pool](https://lightning.engineering/pool/)。例如，Alice 可以购买一个向她的节点的一百万 satoshis 的通道，以便能够接收支付。

![LNP201](assets/en/74.webp)

最后，对于路由器，其目标是最大化处理的支付数量和收集的费用，它们必须：

- 与战略节点开设资金充足的通道。
- 根据网络的需要定期调整通道中的资金分配。

### Loop Out 服务

由 Lightning Labs 提供的 [Loop Out](https://lightning.engineering/loop/) 服务，允许将流动性移动到通道的另一侧，同时在比特币区块链上回收资金。例如，Alice 通过 Lightning 发送 100 万 satoshis 给一个 loop 节点，然后这些资金以链上比特币的形式返回给她。这使她的通道两侧各有 100 万 satoshis，优化了她接收支付的能力。

![LNP201](assets/en/75.webp)

因此，这项服务在回收链上比特币的同时，实现了入站流动性，这有助于限制接受 Lightning 支付所需的现金固定。

**你应该从这一章中学到什么？**

- 要在 Lightning 上发送支付，你必须在你的通道中拥有足够的流动性。要增加这种发送能力，只需开设新的通道。
- 要接收支付，你需要在通道的另一侧拥有流动性。增加这种接收能力更为复杂，因为它需要其他人向你开通通道，或进行（虚构或真实的）支付以将流动性移动到另一侧。
- 根据通道的使用情况，保持所需的流动性可能更具挑战性。这就是为什么存在工具和服务来帮助根据需要平衡通道。

在下一章中，我提议回顾这次培训的最重要概念。

# 进一步了解

<partId>6bbf107d-a224-5916-9f0c-2b4d30dd0b17</partId>

## 培训总结

<chapterId>a65a571c-561b-5e1c-87bf-494644653c22</chapterId>

![结论](https://youtu.be/MaWpD0rbkVo)
在这最后一章，标志着LNP201培训结束，我建议我们一起回顾我们共同覆盖的重要概念。
这次培训的目标是为您提供对闪电网络的全面和技术性理解。我们发现闪电网络是如何依赖比特币区块链来执行链下交易的，同时保留比特币的基本特性，特别是不需要信任其他节点。

### 支付通道

在最初的章节中，我们探讨了如何通过开设支付通道，两方可以在比特币区块链之外进行交易。以下是覆盖的步骤：

1. **通道开启**：通过一笔比特币交易来创建通道，该交易将资金锁定在一个2/2多签名地址中。这笔存款代表了区块链上的闪电通道。

![LNP201](assets/en/76.webp) 2. **通道中的交易**：在这个通道中，然后可以进行多次交易而无需将它们发布到区块链上。每一笔闪电交易都会创建通道的一个新状态，反映在承诺交易中。
![LNP201](assets/en/77.webp)

3. **保护和关闭**：参与者通过交换撤销密钥来承诺通道的新状态，以保护资金并防止任何作弊。双方可以通过在比特币区块链上进行新的交易来合作关闭通道，或者作为最后的手段通过强制关闭。这后一种选项，虽然因为时间更长和有时在费用方面评估不佳而效率较低，但仍然允许资金的回收。在作弊的情况下，受害者可以通过在区块链上回收通道中的所有资金来惩罚作弊者。

![LNP201](assets/en/78.webp)

### 通道网络

在研究了孤立的通道之后，我们将分析扩展到了通道网络：

- **路由**：当两方没有通过通道直接连接时，网络允许通过中间节点进行路由。支付然后从一个节点传输到另一个节点。

![LNP201](assets/en/79.webp)

- **HTLCs**：通过中间节点传输的支付由“_哈希时间锁定合约_”（HTLC）保护，这允许资金被锁定，直到支付从头到尾完成。

![LNP201](assets/en/80.webp)

- **洋葱路由**：为了确保支付的保密性，洋葱路由对中间节点掩盖了最终目的地。因此，发送节点必须计算整个路由，但在缺乏关于通道流动性的完整信息的情况下，它通过连续的尝试来路由支付。

![LNP201](assets/en/81.webp)

### 流动性管理

我们已经看到，在闪电网络上确保支付的顺畅流动是一个挑战。发送支付相对简单：它只需要开设一个通道。然而，接收支付需要在某人的通道的另一侧有流动性。这里讨论了一些策略：

- **吸引通道**：通过鼓励其他节点向自己开通通道，用户获得了进入流动性。

- **移动流动性**：通过向其他通道发送支付，流动性移动到对面。

![LNP201](assets/en/82.webp)

- **使用像Loop和Pool这样的服务**：这些服务允许重新平衡或购买具有对面流动性的通道。
  ![LNP201](assets/en/83.webp)
- **合作开通**：还有平台可用于连接执行三角开通，并拥有进入流动性。

![LNP201](assets/en/84.webp)

# 总结

<partId>b8715c1c-7ae2-49b7-94c7-35bf85346ad3</partId>

## 评价本课程

<chapterId>38814c99-eb7b-5772-af49-4386ee2ce9b0</chapterId>
<isCourseReview>true</isCourseReview>

## 期末考试

<chapterId>7ed33400-aef7-5f3e-bfb1-7867e445d708</chapterId>
<isCourseExam>true</isCourseExam>

## 总结

<chapterId>afc0d72b-4fbc-5893-90b2-e27fb519ad02</chapterId>
恭喜！🎉

您已完成 LNP 201 培训 - Lightning Network 入门！

您可以为自己感到骄傲，因为这不是一个简单的主题。

很少有人能深入比特币的兔子洞到这种程度。

非常感谢 **Fanis Michalakis** 为我们提供这个关于 Lightning Network 技术运作的精彩免费课程。

欢迎在 [Twitter](https://x.com/FanisMichalakis)、[他的博客](https://fanismichalakis.fr/) 或通过他在 [LN Markets](https://lnmarkets.com/) 的工作关注他。

现在您已经掌握了 Lightning Network，我邀请您探索我们在 Plan ₿ Network 上的其他免费课程，以深入了解中本聪发明的其他方面：

#### 了解比特币钱包如何工作

https://planb.network/courses/cyp201

#### 探索比特币起源的历史

https://planb.network/courses/his201

#### 配置 BTC 支付服务器

https://planb.network/courses/btc305

#### 掌握比特币中的隐私原则

https://planb.network/courses/btc204

#### 发现挖矿基础知识

https://planb.network/courses/min201

#### 学习创建您的比特币社区

https://planb.network/courses/btc302

